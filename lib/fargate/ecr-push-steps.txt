http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_AWSCLI_Fargate.html

---

http://docs.aws.amazon.com/AmazonECR/latest/userguide/ECR_on_ECS.html

---

- install python3
- install aws (but use homebrew: https://github.com/aws/aws-cli/issues/727)
- ^ for those steps, see http://docs.aws.amazon.com/cli/latest/userguide/cli-install-macos.html#awscli-install-osx-path

eval $(XYZ=$(aws ecr get-login --region us-east-1) && printf '%s\n' "${XYZ// -e none/}")

aws ecr create-repository --repository-name conjure/watched-1

# NEED TO CHANGE CORE, STRIP OUT -s IN ID
# MAY NEED TO CARRY OVER CONTENT FROM ~/.docker/config.json TO SERVERS (set via eval above...)

export CURR_DIR=$(pwd);

# $( git clone git@github.com:ConjureLabs/mock-web-repo.git poc-proj && cd ./poc-proj && git checkout tmarshall-patch-2 )
# cp ./poc.Dockerfile ./poc-proj/Dockerfile

docker build -t "657781215424.dkr.ecr.us-east-1.amazonaws.com/conjure/watched-1:latest" -f "$CURR_DIR/poc-proj/Dockerfile" "$CURR_DIR/poc-proj";

# docker run -d -p 4320:4320 657781215424.dkr.ecr.us-east-1.amazonaws.com/conjure/watched-1:latest npm start

docker push "657781215424.dkr.ecr.us-east-1.amazonaws.com/conjure/watched-1:latest"

# default region must be us-east-1 (For fargate to work...)
aws ecs register-task-definition --region us-east-1 --cli-input-json file://$CURR_DIR/task-def.json

aws ecs create-cluster --region us-east-1 --cluster-name fargate-cluster


>>> NEW

RUNTASK_RESULT=$(\
  aws ecs run-task \
    --region us-east-1 \
    --cluster fargate-cluster \
    --task-definition sample-fargate:18 \
    --launch-type FARGATE \
    --network-configuration "awsvpcConfiguration={subnets=[subnet-315dbc1e],securityGroups=[sg-616f5e14]}" \
    --count 1 \
);

aws ecs wait tasks-running \
  --region us-east-1  \
  --cluster fargate-cluster \
  --tasks $( echo ${RUNTASK_RESULT} | jq -r '.tasks[0].taskArn' );

<<< NEW




# STOPPED (Essential container in task exited)


>>> OLD

aws ecs create-service --cluster fargate-cluster --service-name fargate-service --task-definition sample-fargate:18 --desired-count 1 --launch-type "FARGATE" --network-configuration "awsvpcConfiguration={subnets=[subnet-315dbc1e],securityGroups=[sg-616f5e14],assignPublicIp='ENABLED'}"

<<< OLD













RUNTASK_RESULT=$(\
  aws ecs run-task \
    --region us-east-1 \
    --cluster fargate-cluster \
    --task-definition sample-fargate \
    --launch-type FARGATE \
    --network-configuration "awsvpcConfiguration={subnets=[subnet-315dbc1e],securityGroups=[sg-616f5e14]}" \
    --count 1 \
);

# NEED jq (brew install jq)
aws ecs wait tasks-running \
  --region us-east-1  \
  --cluster fargate-cluster \
  --tasks $( echo ${RUNTASK_RESULT} | jq -r '.tasks[0].taskArn' );

# getting ip - see https://github.com/pottava/fargate-shell/tree/master/samples/cloud9-go1.8

# WIP
aws --region us-east-1 ecs describe-tasks \
  --cluster fargate-cluster \
  --tasks 4378d4bd-7493-4893-b725-45d10ba655b8